AWSTemplateFormatVersion: '2010-09-09'
Description: '基本情報技術者試験勉強アプリ - Infrastructure as Code'

Parameters:
  DatabasePassword:
    Type: String
    NoEcho: true
    Description: RDS PostgreSQL master password
    MinLength: 8
  
  DatabaseUsername:
    Type: String
    Default: postgres
    Description: RDS PostgreSQL master username
  
  InstanceType:
    Type: String
    Default: db.t3.micro
    Description: RDS instance type
  
  AllocatedStorage:
    Type: Number
    Default: 20
    Description: RDS allocated storage (GB)
  
  SecretKey:
    Type: String
    NoEcho: true
    Description: Flask secret key
    MinLength: 16

Resources:
  # VPC and Networking
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: BasicInfoStudyApp-VPC

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: BasicInfoStudyApp-PublicSubnet1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: BasicInfoStudyApp-PublicSubnet2

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: BasicInfoStudyApp-IGW

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: BasicInfoStudyApp-PublicRT

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # Security Groups
  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS PostgreSQL
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref ElasticBeanstalkSecurityGroup
      Tags:
        - Key: Name
          Value: BasicInfoStudyApp-RDS-SG

  ElasticBeanstalkSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Elastic Beanstalk
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: BasicInfoStudyApp-EB-SG

  # DB Subnet Group
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS
      SubnetIds:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: BasicInfoStudyApp-DBSubnetGroup

  # RDS PostgreSQL Instance
  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: basic-info-study-db
      DBInstanceClass: !Ref InstanceType
      Engine: postgres
      EngineVersion: '15.15'
      MasterUsername: !Ref DatabaseUsername
      MasterUserPassword: !Ref DatabasePassword
      AllocatedStorage: !Ref AllocatedStorage
      StorageType: gp3
      DBName: postgres
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      BackupRetentionPeriod: 1
      PubliclyAccessible: false
      MultiAZ: false
      Tags:
        - Key: Name
          Value: BasicInfoStudyApp-DB

  # Elastic Beanstalk Application
  ElasticBeanstalkApplication:
    Type: AWS::ElasticBeanstalk::Application
    Properties:
      ApplicationName: basic-info-study-app
      Description: Basic Info Study App Backend

  # Elastic Beanstalk Application Version
  ElasticBeanstalkApplicationVersion:
    Type: AWS::ElasticBeanstalk::ApplicationVersion
    Properties:
      ApplicationName: !Ref ElasticBeanstalkApplication
      Description: Application version
      SourceBundle:
        S3Bucket: !Sub '${AWS::AccountId}-elasticbeanstalk-ap-northeast-1'
        S3Key: 'sample-application.zip'
      AutoCreateApplication: false

  # Elastic Beanstalk Environment
  ElasticBeanstalkEnvironment:
    Type: AWS::ElasticBeanstalk::Environment
    Properties:
      ApplicationName: !Ref ElasticBeanstalkApplication
      EnvironmentName: basic-info-study-app-env
      SolutionStackName: '64bit Amazon Linux 2023 v4.9.0 running Python 3.11'
      OptionSettings:
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: DATABASE_URL
          Value: !Sub 
            - 'postgresql://${Username}:${Password}@${Endpoint}:5432/postgres'
            - Username: !Ref DatabaseUsername
              Password: !Ref DatabasePassword
              Endpoint: !GetAtt RDSInstance.Endpoint.Address
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SECRET_KEY
          Value: !Ref SecretKey
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: FLASK_ENV
          Value: production
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: ALLOWED_ORIGINS
          Value: 'http://localhost:3000'
        - Namespace: aws:elasticbeanstalk:container:python
          OptionName: WSGIPath
          Value: application:application
        - Namespace: aws:elasticbeanstalk:environment:process:default
          OptionName: HealthCheckPath
          Value: /api/health
      Tier:
        Name: WebServer
        Type: Standard
      VersionLabel: !Ref ElasticBeanstalkApplicationVersion

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VPCId'

  RDSEndpoint:
    Description: RDS PostgreSQL endpoint
    Value: !GetAtt RDSInstance.Endpoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-RDSEndpoint'

  RDSPort:
    Description: RDS PostgreSQL port
    Value: !GetAtt RDSInstance.Endpoint.Port
    Export:
      Name: !Sub '${AWS::StackName}-RDSPort'

  ElasticBeanstalkURL:
    Description: Elastic Beanstalk environment URL
    Value: !GetAtt ElasticBeanstalkEnvironment.EndpointURL
    Export:
      Name: !Sub '${AWS::StackName}-ElasticBeanstalkURL'

  DatabaseConnectionString:
    Description: Database connection string (without password)
    Value: !Sub 
      - 'postgresql://${Username}@${Endpoint}:5432/postgres'
      - Username: !Ref DatabaseUsername
        Endpoint: !GetAtt RDSInstance.Endpoint.Address

